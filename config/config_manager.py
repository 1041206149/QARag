"""配置管理模块统一管理所有配置项，包括YAML配置和环境变量"""import osimport yamlimport loggingfrom pathlib import Pathfrom typing import Dict, Any, Optionalfrom dotenv import load_dotenv# 加载环境变量load_dotenv()logger = logging.getLogger(__name__)class ConfigManager:    """配置管理器 - 单例模式"""    _instance = None    _config = None    def __new__(cls):        if cls._instance is None:            cls._instance = super().__new__(cls)        return cls._instance    def __init__(self):        if self._config is None:            self._load_config()    @property    def project_root(self) -> Path:        """获取项目根目录"""        return Path(__file__).resolve().parent.parent    def _load_config(self):        """加载配置文件"""        config_file = self.project_root / "config" / "config.yaml"        try:            with open(config_file, 'r', encoding='utf-8') as f:                self._config = yaml.safe_load(f)            logger.info(f"配置文件加载成功: {config_file}")        except Exception as e:            logger.warning(f"加载配置文件失败: {e}，使用默认配置")            self._config = self._get_default_config()    def _get_default_config(self) -> Dict[str, Any]:        """获取默认配置"""        return {            'data': {                'raw_data_path': 'data/raw/qa_pairs_rag.json',                'processed_data_path': 'data/processed'            },            'embedding': {                'model_name': 'sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2',                'batch_size': 32,                'cache_dir': 'data/processed'            },            'vector_store': {                'type': 'faiss',                'index_path': 'vector_store/faiss_index',                'index_type': 'flat'            },            'retrieval': {                'top_k': 3,                'similarity_threshold': 0.7,                'use_cache': True            },            'llm': {                'provider': 'openai',                'model': 'gpt-4o-mini',                'temperature': 1.0,                'max_tokens': 1000,                'timeout': 30            },            'logging': {                'level': 'INFO',                'file': 'logs/app.log',                'format': '%(asctime)s - %(name)s - %(levelname)s - %(message)s'            },            'system': {                'cache_enabled': True,                'parallel_processing': False,                'max_workers': 4            }        }    def get(self, key: str, default: Any = None) -> Any:        """        获取配置项（支持点号分隔的嵌套键）        Args:            key: 配置键，如 'data.raw_data_path' 或 'embedding.model_name'            default: 默认值        Returns:            配置值        """        keys = key.split('.')        value = self._config        try:            for k in keys:                value = value[k]            return value        except (KeyError, TypeError):            return default    def get_path(self, key: str) -> Path:        """        获取路径配置（自动转换为绝对路径）        Args:            key: 配置键        Returns:            绝对路径        """        relative_path = self.get(key)        if relative_path is None:            raise ValueError(f"配置项不存在: {key}")        return self.project_root / relative_path    # 便捷访问方法    @property    def data_config(self) -> Dict[str, Any]:        """数据配置"""        return self._config.get('data', {})    @property    def embedding_config(self) -> Dict[str, Any]:        """向量化配置"""        return self._config.get('embedding', {})    @property    def vector_store_config(self) -> Dict[str, Any]:        """向量存储配置"""        return self._config.get('vector_store', {})    @property    def retrieval_config(self) -> Dict[str, Any]:        """检索配置"""        return self._config.get('retrieval', {})    @property    def llm_config(self) -> Dict[str, Any]:        """LLM配置"""        config = self._config.get('llm', {}).copy()        # 环境变量优先级更高        config['model'] = os.getenv('OPENAI_MODEL', config.get('model', 'gpt-4o-mini'))        config['api_key'] = os.getenv('OPENAI_API_KEY')        config['base_url'] = os.getenv('OPENAI_API_BASE')        config['temperature'] = float(os.getenv('OPENAI_TEMPERATURE', config.get('temperature', 1.0)))        return config    @property    def logging_config(self) -> Dict[str, Any]:        """日志配置"""        return self._config.get('logging', {})    @property    def system_config(self) -> Dict[str, Any]:        """系统配置"""        return self._config.get('system', {})    def setup_logging(self):        """配置日志系统"""        log_config = self.logging_config        log_level = getattr(logging, log_config.get('level', 'INFO'))        log_file = self.project_root / log_config.get('file', 'logs/app.log')        # 确保日志目录存在        log_file.parent.mkdir(parents=True, exist_ok=True)        # 配置日志格式        formatter = logging.Formatter(            log_config.get('format', '%(asctime)s - %(name)s - %(levelname)s - %(message)s'),            datefmt='%Y-%m-%d %H:%M:%S'        )        # 清除现有的处理器        root_logger = logging.getLogger()        for handler in root_logger.handlers[:]:            root_logger.removeHandler(handler)        # 文件处理器        file_handler = logging.FileHandler(log_file, encoding='utf-8')        file_handler.setFormatter(formatter)        # 控制台处理器        console_handler = logging.StreamHandler()        console_handler.setFormatter(formatter)        # 配置根日志器        root_logger.setLevel(log_level)        root_logger.addHandler(file_handler)        root_logger.addHandler(console_handler)        logger.info(f"日志系统已配置: {log_file}")# 创建全局配置实例config = ConfigManager()